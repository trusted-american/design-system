<Button
  @text={{@text}}
  @icon="filter"
  @count={{this.selections.length}}
  data-test-list-filter
  {{dropdown autoClose="outside"}}
/>

<Dropdown class="p-0" data-test-list-filter-dropdown>
  <form novalidate {{on "submit" this.done}}>
    <ListGroup @isFlush={{true}}>

      <ListGroup::Item class="bg-body-tertiary px-2">
        <ButtonSet class="justify-content-between">
          <Button
            @text={{@clearText}}
            data-test-clear
            {{on "click" this.clear}}
          />
          <Button
            @isSubmit={{true}}
            @text={{@doneText}}
            @color="primary"
            data-test-done
          />
        </ButtonSet>
      </ListGroup::Item>

      {{#each this.predicates as |predicate index|}}
        <label class="list-group-item px-2" data-test-predicate-toggle>
          <Form::Check::Input
            @value={{if
              (or predicate.value (eq false predicate.value))
              true
              false
            }}
            @label={{predicate.label}}
            @identifier="toggle{{index}}"
            @onChange={{fn this.toggle predicate}}
            class="me-1"
          />
          {{predicate.label}}
        </label>

        {{#if (or predicate.value (eq false predicate.value))}}
          <ListGroup::Item
            class="bg-body-tertiary px-2"
            data-test-predicate-value
          >

            {{#if (eq "date" predicate.type)}}
              <Form::Select
                @options={{array
                  (hash value="inTheLast" label=@inTheLastText)
                  (hash value="equals" label=@equalsText)
                  (hash value="between" label=@betweenText)
                  (hash value="isAfter" label=@isAfterText)
                  (hash value="isAfterOrOn" label=@isAfterOrOnText)
                  (hash value="isBefore" label=@isBeforeText)
                  (hash value="isBeforeOrOn" label=@isBeforeOrOnText)
                }}
                @selected={{predicate.mode}}
                @label={{@modeText}}
                @identifier="mode{{index}}"
                @isInputOnly={{true}}
                @onChange={{fn (mut predicate.mode)}}
                class="mb-2"
              />

              <div class="d-flex align-items-center gap-2">
                {{#if (eq "inTheLast" predicate.mode)}}
                  <Form::NumberInput
                    @value={{predicate.valueA}}
                    @label={{@valueAText}}
                    @identifier="valueA{{index}}"
                    @isRequired={{true}}
                    @isInputOnly={{true}}
                    @onChange={{fn (mut predicate.valueA)}}
                    min="1"
                  />
                  <Form::Select
                    @options={{array
                      (hash value="days" label=@daysText)
                      (hash value="months" label=@monthsText)
                    }}
                    @selected={{predicate.valueB}}
                    @label={{@valueBText}}
                    @identifier="valueB{{index}}"
                    @isInputOnly={{true}}
                    @onChange={{fn (mut predicate.valueB)}}
                  />
                {{else}}
                  <Form::DateInput
                    @value={{predicate.valueA}}
                    @label={{@valueAText}}
                    @identifier="valueA{{index}}"
                    @isRequired={{true}}
                    @isInputOnly={{true}}
                    @isLocalTimeZone={{true}}
                    @onChange={{fn (mut predicate.valueA)}}
                  />
                  {{#if (eq "between" predicate.mode)}}
                    <div>{{@andText}}</div>
                    <Form::DateInput
                      @value={{predicate.valueB}}
                      @label={{@valueBText}}
                      @identifier="valueB{{index}}"
                      @isRequired={{true}}
                      @isInputOnly={{true}}
                      @isLocalTimeZone={{true}}
                      @onChange={{fn this.setValueB predicate}}
                    />
                  {{/if}}
                {{/if}}
              </div>

            {{else if (eq "multi" predicate.type)}}

              {{#each predicate.options as |opt|}}
                <Form::Check
                  @value={{includes opt.value predicate.value}}
                  @label={{opt.label}}
                  @identifier="{{opt.value}}"
                  @onChange={{fn this.toggleMulti predicate opt.value}}
                />
              {{/each}}

            {{else if (eq "string" predicate.type)}}

              <Form::Input
                @value={{predicate.value}}
                @label={{@valueText}}
                @identifier="value{{index}}"
                @isRequired={{true}}
                @isInputOnly={{true}}
                @onChange={{fn (mut predicate.value)}}
                placeholder="Value"
                {{autoselect}}
              />

            {{else}}

              <Form::PowerSelect
                @options={{predicate.options}}
                @selected={{find-by "value" predicate.value predicate.options}}
                @searchField="label"
                @label={{@valueText}}
                @identifier="value{{index}}"
                @isRequired={{true}}
                @isInputOnly={{true}}
                @chooseText={{@chooseText}}
                @searchText={{@searchText}}
                @onChange={{fn this.change predicate}}
                as |option|
              >
                {{option.label}}
              </Form::PowerSelect>

            {{/if}}
          </ListGroup::Item>
        {{/if}}
      {{/each}}
    </ListGroup>
  </form>
</Dropdown>